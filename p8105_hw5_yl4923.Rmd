---
title: 'p8105_hw5_yl4923'
author: "Yujia Li"
date: "11/19/2021"
output: github_document
---

## Problem 0
--create my public Github repo and local R with a single .Rmd file that renders to github_document
--create a sub-directory to store the local data files used in the assignment, and use relative paths to access these data files
```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(p8105.datasets)

knitr::opts_chunk$set(echo = TRUE)
```

## Problem 1 
```{r}
# 1.1 Create a city_state variable and describe raw data
homi_df = 
  read_csv("./data/homicide-data.csv",na = c("","Unknown")) %>% 
  mutate(
    city_state = str_c(city, state),
    resolution = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest" ~ "unsolved",
      disposition == "Closed by arrest" ~ "solved"
    )) %>%
  relocate(city_state) %>%
  filter(city_state != "TulsaAL")
```
The homicides data records  `r dim(homi_df)[1]` accidents identified by `r dim(homi_df)[2]` variables in major cities during the past ten years. Key variables include victim characteristics (name, age, sex, etc.), disposition, location (city/state).

The total number of homicides and the number of unsolved homicides within cities are summarized below:
```{r}
homi_stat = 
  homi_df %>% 
  group_by(city_state) %>% 
  summarise(
    unsolved = sum(disposition %in% c("Closed without arrest", "Open/No arrest")), 
    total_number = n()
    )

knitr::kable(homi_stat)
```

```{r}
# 1.2 prop.test function for Baltimore
baltimore_df = 
  homi_df %>%
  filter(city_state == "BaltimoreMD")

baltimore_summary = 
  baltimore_df %>% 
  summarize(
    unsolved = sum(resolution == "unsolved"),
    n = n())

baltimore_test = 
  prop.test(
    x = baltimore_summary %>% pull(unsolved),
    n = baltimore_summary %>% pull(n)
)

baltimore_test %>% 
  broom::tidy()
```

```{r}
# 1.3 run `prop.test` for each of the cities by writing a function
prop_test_function = function(city_df) {
  city_summary = 
    city_df %>% 
    summarize(
      unsolved = sum(resolution == "unsolved"),
      n = n()
    )
  city_test = 
    prop.test(
      x = city_summary %>% pull(unsolved),
      n = city_summary %>% pull(n))
  
  return(city_test)
}

prop_test_function(baltimore_df) #use Baltimore test the function and then run across all cities

nested_df = 
  homi_df %>%
  nest(data = uid:resolution) %>%
  mutate(
    test_results = map(data, prop_test_function),
    tidy_results = map(test_results, broom::tidy)
  ) %>%
  select(city_state, tidy_results) %>%
  unnest(tidy_results) %>%
  select(city_state, estimate, starts_with("conf"))
```
